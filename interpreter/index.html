<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JS-Interpreter Demo</title>
  <!-- <link href="demos/style.css" rel="stylesheet" type="text/css"> -->
  <link href="style.css" rel="stylesheet" type="text/css">

  <script>
    var lines = [];
    var prevLine = "";
    // var number = 2;
    // Depending on the URL argument, test the compressed or uncompressed version.
    var compressed = (document.location.search == '?compressed');
    if (compressed) {
        document.write('<scr'+'ipt src="acorn_interpreter.js"></scr'+'ipt>');
    } else {
        document.write('<scr'+'ipt src="acorn.js"></scr'+'ipt>');
        document.write('<scr'+'ipt src="interpreter.js"></scr'+'ipt>');
    }

    var myInterpreter;
    function initAlert(interpreter, scope) {
        var alert_wrapper = function(text) {
            return alert(arguments.length ? text : '');
        };

        var print_wrapper = function(text) {
            return console.log(arguments.length ? text : '');
        };

        // interpreter.setProperty(scope, 'number', String(location));
        interpreter.setProperty(scope, 'number', 16);
        interpreter.setProperty(scope, 'alert', interpreter.createNativeFunction(alert_wrapper));
        interpreter.setProperty(scope, 'print', interpreter.createNativeFunction(print_wrapper));
    }

    function parseButton() {
        var code = document.getElementById('code').value;
        myInterpreter = new Interpreter(code, initAlert);
        disable('');
    }

    function stepButton() {
        while (true) {
            if (myInterpreter.stateStack.length) {
                // console.log("stepButton 1");
                var node = myInterpreter.stateStack[myInterpreter.stateStack.length - 1].node;
                var start = node.start;
                var end = node.end;
            } else {
                // console.log("stepButton 2");
                var start = 0;
                var end = 0;
            }
            createSelection(start, end);

            var code = document.getElementById('code').value;
            var codeSelected = code.substring(start, end);
            // console.log(codeSelected);

            try {
                var ok = myInterpreter.step();
            } finally {
                if (!ok) {
                    disable('disabled');
                }
            }

            if (codeSelected.length == 1) {
                // console.log('continue 1')
                continue;
            }

            var countLineEnd = (codeSelected.match(/\n/g) || []).length;
            // console.log(countLineEnd);

            if (countLineEnd > 1) {
                // console.log('continue 2')
                continue;
            }

            if (codeSelected[0] == '[' && codeSelected[codeSelected.length - 1] == ']') {
                // console.log('continue 3')
                continue;
            }

            // if (lines.indexOf(codeSelected) != -1) {
            //     continue;
            // }
            // var found = lines.findIndex(function(l) {
            //     return l.includes(codeSelected);
            // });
            // if (found != -1) {
            //     continue;
            // }

            console.log(prevLine)
            console.log(codeSelected)
            if (prevLine.includes(codeSelected)) {
                // prevLine = codeSelected;
                // console.log('continue 4')
                continue;
            }
            prevLine = codeSelected;


            // if (countLineEnd == 0) {
            //     break;
            // }

            // lines.push(codeSelected);

            // console.log('break 1')
            break;
        }
    }

    function runButton() {
        disable('disabled');
        myInterpreter.run();
    }

    function disable(disabled) {
        document.getElementById('stepButton').disabled = disabled;
        document.getElementById('runButton').disabled = disabled;
    }

    function createSelection(start, end) {
        var field = document.getElementById('code');
        if (field.createTextRange) {
            var selRange = field.createTextRange();
            selRange.collapse(true);
            selRange.moveStart('character', start);
            selRange.moveEnd('character', end);
            selRange.select();
        } else if (field.setSelectionRange) {
            field.setSelectionRange(start, end);
        } else if (field.selectionStart) {
            field.selectionStart = start;
            field.selectionEnd = end;
        }
        field.focus();
    }
  </script>
</head>
<body>
  <h1>JS-Interpreter Demo</h1>

  <p>Enter JavaScript code below, then click <em>Parse</em>.  To execute, either
  click <em>Step</em> repeatedly, or click <em>Run</em> once.
  Open your browser's console for errors.</p>
  <!-- <p><textarea id="code">
var result = [];
function fibonacci(n, output) {
  var a = 1, b = 1, sum;
  for (var i = 0; i &lt; n; i++) {
    output.push(a);
    sum = a + b;
    a = b;
    b = sum;
  }
}
fibonacci(number, result);
alert(result.join(', '));
print(result.join(', '));

</textarea><br> -->

<p><textarea id="code">
function find(data, x) {
    for (var i = 0; i &lt; data.length; ++i) {
        if (data[i] == x) {
            return i;
        }
    }
    return data.length;
}

var data = [1, 2, 3, 4];
var pos = find(data, 3);
alert(pos);
print(pos);
        </textarea><br>
        

<button onclick="parseButton()">Parse</button>
  <button onclick="stepButton()" id="stepButton" disabled="disabled">Step</button>
  <button onclick="runButton()" id="runButton" disabled="disabled">Run</button>
  </p>

  <p><small>
  <script>
    if (compressed) {
      document.write('[ Running compressed bundle.  Switch to <A HREF="?uncompressed">raw sources</A>. ]');
    } else {
      document.write('[ Running raw sources.  Switch to <A HREF="?compressed">compressed bundle</A>. ]');
    }
    disable('disabled');
  </script>
  </small></p>

  <p>Read the <a href="docs.html">JS-Interpreter documentation</a>.</p>
  <p>Get the <a href="https://github.com/NeilFraser/JS-Interpreter">source code</a>.</p>

</body>
</html>